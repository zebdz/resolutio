// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../generated/prisma"
  engineType    = "client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// Enums
enum PollState {
  DRAFT
  READY
  ACTIVE
  FINISHED
}

// Authentication Models
model User {
  id          String   @id @default(cuid())
  firstName   String   @map("first_name")
  lastName    String   @map("last_name")
  middleName  String?  @map("middle_name")
  phoneNumber String   @unique @map("phone_number")
  password    String
  language    String   @default("ru")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  sessions           Session[]
  organizationsOwned Organization[]
  memberships        OrganizationUser[]
  adminRoles         OrganizationAdminUser[]
  boardMemberships   BoardUser[]
  boardMembersAdded  BoardUser[]        @relation("AddedBoardMember")
  boardMembersRemoved BoardUser[]       @relation("RemovedBoardMember")
  votes              Vote[]
  pollsCreated       Poll[]
  superAdmin         SuperAdmin?
  acceptedRequests   OrganizationUser[] @relation("AcceptedByAdmin")
  rejectedRequests   OrganizationUser[] @relation("RejectedByAdmin")
  pollParticipants   PollParticipant[]
  voteDrafts         VoteDraft[]
  weightChanges      ParticipantWeightHistory[] @relation("WeightChangedBy")

  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model SuperAdmin {
  userId    String   @id @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("superadmins")
}

// Organization Models
model Organization {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  parentId    String?  @map("parent_id")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  archivedAt  DateTime? @map("archived_at")

  // Relations
  createdBy   User                    @relation(fields: [createdById], references: [id])
  parent      Organization?           @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children    Organization[]          @relation("OrganizationHierarchy")
  members     OrganizationUser[]
  admins      OrganizationAdminUser[]
  boards      Board[]

  @@index([parentId])
  @@index([createdById])
  @@map("organizations")
}

model OrganizationUser {
  id                String    @id @default(cuid())
  organizationId    String    @map("organization_id")
  userId            String    @map("user_id")
  status            String    @default("pending") // "pending" | "accepted" | "rejected"
  createdAt         DateTime  @default(now()) @map("created_at")
  acceptedAt        DateTime? @map("accepted_at")
  rejectedAt        DateTime? @map("rejected_at")
  rejectionReason   String?   @map("rejection_reason")
  acceptedByUserId  String?   @map("accepted_by_user_id")
  rejectedByUserId  String?   @map("rejected_by_user_id")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  acceptedBy   User?        @relation("AcceptedByAdmin", fields: [acceptedByUserId], references: [id])
  rejectedBy   User?        @relation("RejectedByAdmin", fields: [rejectedByUserId], references: [id])

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([acceptedByUserId])
  @@index([rejectedByUserId])
  @@map("organization_users")
}

model OrganizationAdminUser {
  organizationId String   @map("organization_id")
  userId         String   @map("user_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([organizationId, userId])
  @@index([userId])
  @@map("organization_admin_users")
}

// Board Models
model Board {
  id             String    @id @default(cuid())
  name           String
  organizationId String    @map("organization_id")
  isGeneral      Boolean   @default(false) @map("is_general")
  createdAt      DateTime  @default(now()) @map("created_at")
  archivedAt     DateTime? @map("archived_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      BoardUser[]
  polls        Poll[]

  @@unique([name, organizationId])
  @@index([organizationId])
  @@index([organizationId, isGeneral])
  @@map("boards")
}

model BoardUser {
  id            String    @id @default(cuid())
  boardId       String    @map("board_id")
  userId        String    @map("user_id")
  addedBy       String?   @map("added_by")
  addedAt       DateTime  @default(now()) @map("added_at")
  removedBy     String?   @map("removed_by")
  removedAt     DateTime? @map("removed_at")
  removedReason String?   @map("removed_reason")
  createdAt     DateTime  @default(now()) @map("created_at")

  board         Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user          User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedByUser   User? @relation("AddedBoardMember", fields: [addedBy], references: [id])
  removedByUser User? @relation("RemovedBoardMember", fields: [removedBy], references: [id])

  @@unique([boardId, userId])
  @@index([userId])
  @@index([addedBy])
  @@index([removedBy])
  @@map("board_users")
}

// Poll Models
model Poll {
  id             String    @id @default(cuid())
  title          String
  description    String
  boardId        String    @map("board_id")
  startDate      DateTime  @map("start_date")
  endDate        DateTime  @map("end_date")
  state          PollState @default(DRAFT)
  weightCriteria String?   @map("weight_criteria")
  createdBy      String    @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at")
  archivedAt     DateTime? @map("archived_at")

  board        Board                          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  creator      User                           @relation(fields: [createdBy], references: [id])
  questions    Question[]
  participants PollParticipant[]
  voteDrafts   VoteDraft[]

  @@index([boardId])
  @@index([state])
  @@index([createdBy])
  @@map("polls")
}

model Question {
  id           String    @id @default(cuid())
  text         String
  details      String?
  pollId       String    @map("poll_id")
  page         Int       @default(1)
  order        Int       @default(0)
  questionType String    @default("single-choice") @map("question_type") // "single-choice" | "multiple-choice"
  createdAt    DateTime  @default(now()) @map("created_at")
  archivedAt   DateTime? @map("archived_at")

  poll    Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  answers Answer[]
  votes   Vote[]
  voteDrafts VoteDraft[]

  @@index([pollId])
  @@index([pollId, page, order])
  @@map("questions")
}

model Answer {
  id         String    @id @default(cuid())
  text       String
  questionId String    @map("question_id")
  order      Int       @default(0)
  createdAt  DateTime  @default(now()) @map("created_at")
  archivedAt DateTime? @map("archived_at")

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  votes    Vote[]
  voteDrafts VoteDraft[]

  @@index([questionId])
  @@map("answers")
}

model Vote {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  answerId   String   @map("answer_id")
  userId     String   @map("user_id")
  userWeight Decimal  @default(1.0) @map("user_weight") @db.Decimal(10, 2)
  createdAt  DateTime @default(now()) @map("created_at")

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer   Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questionId, userId, answerId])
  @@index([answerId])
  @@index([userId])
  @@map("votes")
}

model PollParticipant {
  id         String   @id @default(cuid())
  pollId     String   @map("poll_id")
  userId     String   @map("user_id")
  userWeight Decimal  @default(1.0) @map("user_weight") @db.Decimal(10, 2)
  snapshotAt DateTime @default(now()) @map("snapshot_at")
  createdAt  DateTime @default(now()) @map("created_at")

  poll          Poll                           @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user          User                           @relation(fields: [userId], references: [id], onDelete: Cascade)
  weightHistory ParticipantWeightHistory[]

  @@unique([pollId, userId])
  @@index([pollId])
  @@index([userId])
  @@map("poll_participants")
}

model ParticipantWeightHistory {
  id            String   @id @default(cuid())
  participantId String   @map("participant_id")
  pollId        String   @map("poll_id")
  userId        String   @map("user_id")
  oldWeight     Decimal  @db.Decimal(10, 2) @map("old_weight")
  newWeight     Decimal  @db.Decimal(10, 2) @map("new_weight")
  changedBy     String   @map("changed_by")
  reason        String?
  changedAt     DateTime @default(now()) @map("changed_at")

  participant    PollParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  changedByUser  User            @relation("WeightChangedBy", fields: [changedBy], references: [id])

  @@index([participantId])
  @@index([pollId])
  @@index([userId])
  @@index([changedBy])
  @@map("participant_weight_history")
}

model VoteDraft {
  id         String   @id @default(cuid())
  pollId     String   @map("poll_id")
  questionId String   @map("question_id")
  answerId   String   @map("answer_id")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  poll     Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer   Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, questionId, userId, answerId])
  @@index([pollId])
  @@index([questionId])
  @@index([userId])
  @@index([pollId, userId])
  @@map("vote_drafts")
}
