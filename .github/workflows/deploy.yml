name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SERVER_USER: www-root
      SERVER_IP: 89.111.171.11
      DEPLOY_DIR: /var/www/www-root/data/www/resolutio.site
      SITE_URL: https://resolutio.site

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build application
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: yarn build

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            .next/ \
            node_modules/ \
            generated/ \
            prisma/ \
            public/ \
            package.json \
            next.config.ts \
            prisma.config.ts \
            migrate-production.sh \
            deploy-on-server.sh \
            start-production.sh

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ env.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to production server
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DEPLOY_DIR: ${{ env.DEPLOY_DIR }}
        run: |
          # Upload deployment package
          echo "ðŸ“¦ Uploading deployment package..."
          scp -i ~/.ssh/id_ed25519 deploy.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_IP }}:${DEPLOY_DIR}/

          # Execute deployment on server
          echo "ðŸš€ Deploying on production server..."
          ssh -i ~/.ssh/id_ed25519 ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} << EOF
            cd ${DEPLOY_DIR}
            
            # Extract the deployment package
            echo "ðŸ“‚ Extracting deployment package..."
            tar -xzf deploy.tar.gz
            
            # Make deployment script executable
            chmod +x deploy-on-server.sh
            
            # Run deployment script
            ./deploy-on-server.sh
            
            # Show the last few lines of the log if it exists
            echo ""
            if [ -f deploy.log ]; then
              echo "Recent deployment log:"
              tail -20 deploy.log
            else
              echo "No deployment log found (deploy.log doesn't exist yet)"
            fi
          EOF

          echo "âœ… Deployment complete!"

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          echo "Waiting for server to fully start..."
          sleep 10

          # Try multiple times in case server is still starting
          MAX_ATTEMPTS=3
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.SITE_URL }}/ru || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "301" ]; then
              echo "âœ… Site is responding (HTTP $HTTP_CODE)"
              break
            else
              echo "âš ï¸  Site returned HTTP $HTTP_CODE"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Waiting 5 seconds before retrying..."
                sleep 5
              else
                echo "âš ï¸  Warning: Site may need manual verification"
                echo "However, deployment was completed and ISP panel should have restarted the app"
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_ed25519
